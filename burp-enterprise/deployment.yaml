apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ${STATEFUL_SET}
  namespace: ${NAMESPACE}
spec:
  serviceName: ${SERVICE}
  selector:
    matchLabels:
      service: ${SERVICE}
  template:
    metadata:
      labels:
        service: ${SERVICE}
    spec:
      serviceAccountName: ${SERVICE_ACCOUNT}
      runtimeClassName: gvisor
      nodeSelector:
        cloud.google.com/gke-nodepool: apps

      volumes:
      - name: ${SERVICE_VOLUME}
        persistentVolumeClaim:
          claimName: ${SERVICE_VOLUME}
      - name: ${SECRET_CONFIG_VOLUME}
        secret:
          secretName: ${SECRET_CONFIG}
      - name: ${LOGBACK_CONFIG_VOLUME}
        configMap:
          name: ${LOGBACK_CONFIG}

      containers:
      - name: burp-enterprise
        image: us.gcr.io/${PROJECT_ID}/burp-enterprise
        imagePullPolicy: Always
        command: ['bash', '-c']
        args:
        - |
          set -e

          cd /usr/local/burpsuite_enterprise
          sed -i 's|\(logback.configurationFile=\)[^ ]*|\1${LOGBACK_CONFIG_PATH}/${LOGBACK_CONFIG_FILE}|' */component.sh
          mkfifo "${LOGBACK_LOG_FILE}"
          chown burpsuite "${LOGBACK_LOG_FILE}"

          cd enterpriseServer/20*
          cp "${SECRET_CONFIG_PATH}/${SECRET_CONFIG_FILE}" .
          chown burpsuite "${SECRET_CONFIG_FILE}"

          cd /etc/init.d
          ./burpsuiteenterpriseedition_agent start
          ./burpsuiteenterpriseedition_enterpriseserver start
          ./burpsuiteenterpriseedition_webserver start

          exec cat "${LOGBACK_LOG_FILE}"
        ports:
        - name: ${TARGET_PORT}
          containerPort: 8080
        readinessProbe:
          httpGet:
            path: /
            port: ${TARGET_PORT}
          timeoutSeconds: 10
          initialDelaySeconds: 60
        volumeMounts:
        - name: ${SERVICE_VOLUME}
          subPath: usr/local/burpsuite_enterprise
          mountPath: /usr/local/burpsuite_enterprise
        - name: ${SERVICE_VOLUME}
          subPath: var/lib/BurpSuiteEnterpriseEdition
          mountPath: /var/lib/BurpSuiteEnterpriseEdition
        - name: ${SECRET_CONFIG_VOLUME}
          mountPath: ${SECRET_CONFIG_PATH}
        - name: ${LOGBACK_CONFIG_VOLUME}
          mountPath: ${LOGBACK_CONFIG_PATH}
        resources:
          requests:
            memory: 2300M

      - name: cloudsql-proxy
        # workaround for instance metadata endpoint issue
        # image: gcr.io/cloudsql-docker/gce-proxy
        image: ${CLOUDSQL_PROXY_IMAGE}
        imagePullPolicy: Always
        command:
        - /cloud_sql_proxy
        - -instances=${PROJECT_ID}:${SQL_REGION}:${SQL_INSTANCE}=tcp:${DB_PORT}
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: ${SERVICE_ACCOUNT}-sa-sql-policy
  namespace: ${NAMESPACE}
spec:
  member: serviceAccount:${SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com
  role: roles/cloudsql.client
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: projects/${PROJECT_ID}
---
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLInstance
metadata:
  name: ${SQL_INSTANCE}
  namespace: ${NAMESPACE}
  annotations:
    cnrm.cloud.google.com/deletion-policy: abandon
spec:
  databaseVersion: POSTGRES_11
  region: ${SQL_REGION}
  settings:
    tier: db-custom-1-3840
    backupConfiguration:
      enabled: true
---
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLDatabase
metadata:
  name: ${DB_NAME}
  namespace: ${NAMESPACE}
  annotations:
    cnrm.cloud.google.com/deletion-policy: abandon
spec:
  instanceRef:
    name: ${SQL_INSTANCE}
---
apiVersion: sql.cnrm.cloud.google.com/v1beta1
kind: SQLUser
metadata:
  name: ${DB_USER}
  namespace: ${NAMESPACE}
  annotations:
    cnrm.cloud.google.com/deletion-policy: abandon
spec:
  instanceRef:
    name: ${SQL_INSTANCE}
  password:
    valueFrom:
      secretKeyRef:
        name: ${DB_SECRET}
        key: DB_PASSWORD
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ${LOGBACK_CONFIG}
  namespace: ${NAMESPACE}
data:
  ${LOGBACK_CONFIG_FILE}: |-
    <configuration>
      <appender name="main" class="ch.qos.logback.core.FileAppender">
        <file>${LOGBACK_LOG_FILE}</file>
        <encoder>
          <pattern>%-5level [%thread] %logger{36} - %msg%n</pattern>
        </encoder>
      </appender>
      <root level="INFO">
        <appender-ref ref="main" />
      </root>
    </configuration>
