<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Broad Institute Security Documentation Portal Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Broad Institute Security Documentation Portal Blog Atom Feed"><title data-react-helmet="true">Kubernetes Cluster Architecture | Broad Institute Security Documentation Portal</title><meta data-react-helmet="true" property="og:url" content="https://broadinstitute.github.io//docs/SDARQ/How_It_Works/kubernetes-cluster"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Kubernetes Cluster Architecture | Broad Institute Security Documentation Portal"><meta data-react-helmet="true" name="description" content="Deployment"><meta data-react-helmet="true" property="og:description" content="Deployment"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://broadinstitute.github.io//docs/SDARQ/How_It_Works/kubernetes-cluster"><link data-react-helmet="true" rel="alternate" href="https://broadinstitute.github.io//docs/SDARQ/How_It_Works/kubernetes-cluster" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://broadinstitute.github.io//docs/SDARQ/How_It_Works/kubernetes-cluster" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f450f5b8.css">
<link rel="preload" href="/assets/js/runtime~main.35195b03.js" as="script">
<link rel="preload" href="/assets/js/main.5e765113.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/tooling-logo.svg" alt="SDARQ" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tooling-logo.svg" alt="SDARQ" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Broad Institute</strong></a><a class="navbar__item navbar__link" href="/docs/SDARQ/Overview">SDARQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/broadinstitute/dsp-appsec-infrastructure-apps" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/tooling-logo.svg" alt="SDARQ" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/tooling-logo.svg" alt="SDARQ" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Broad Institute</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/SDARQ/Overview">SDARQ</a></li><li class="menu__list-item"><a href="https://github.com/broadinstitute/dsp-appsec-infrastructure-apps" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">SDARQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SDARQ/Overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SDARQ/Quickstart">Quick Start</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">How_It_Works</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/SDARQ/How_It_Works/sdarq-apps">SDARQ Apps</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/SDARQ/How_It_Works/kubernetes-cluster">AppSec Infrastructure</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Security_Guidance</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Cloud_Security</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/Security_Guidance/Cloud_Security/Overview">Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/Security_Guidance/Overview">Overview</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Infrastructure</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h2><p>All apps are deployed via Cloud Build, as defined in cloudbuild.yaml.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="shared-resources"></a>Shared resources<a class="hash-link" href="#shared-resources" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="terraform"></a>Terraform<a class="hash-link" href="#terraform" title="Direct link to heading">#</a></h3><p>First, it sets up some common infrastructure:</p><ol><li><p>Using Terraform templates, it deploys a <em>regional</em> GKE cluster with</p><ul><li><p>a dedicated VPC network/subnetwork in <code>us-east1</code> region</p></li><li><p>VPC-native networking with
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips" target="_blank" rel="noopener noreferrer">alias IPs</a>,
to optimize pod communication and provide some security benefits</p></li><li><p>a minimal-privilege GKE node service account
with access to Stackdriver logging/monitoring
and Google Container Registry</p></li><li><p><code>system</code> and <code>sandbox</code> node pools,
spread across 2 availability zones in the region</p></li><li><p><a href="https://cloud.google.com/kubernetes-engine/sandbox" target="_blank" rel="noopener noreferrer">GKE Sandbox</a>
enabled for <code>sandbox</code> pool,
which will be used for app deployments
(with additional configuration for the pods, see below).</p></li><li><p><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/using-containerd" target="_blank" rel="noopener noreferrer">Container-Optimized OS with <code>containerd</code> runtime</a>
image for the nodes (this is required by GKE Sandbox,
but we also use it for &quot;system&quot; nodes, to minimize Docker exposure surface)</p></li><li><p><a href="https://cloud.google.com/security/shielded-cloud/shielded-vm" target="_blank" rel="noopener noreferrer">Shielded VMs</a>
for all nodes</p></li><li><p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" target="_blank" rel="noopener noreferrer">Workload Identity</a> for minimal-privilege app deployments</p></li><li><p><a href="https://cloud.google.com/kubernetes-engine/docs/tutorials/network-policy" target="_blank" rel="noopener noreferrer">Network Policy</a> cluster add-on for future Pod deployments</p></li><li><p><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler" target="_blank" rel="noopener noreferrer">Cluster Autoscaler</a>
for <code>sandbox</code> pool, to gradually grow the number of nodes as more workloads are deployed to them</p></li><li><p><em>Regular</em> <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels" target="_blank" rel="noopener noreferrer">release channel</a> for cluster/node upgrades</p></li></ul></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gke-config-connector"></a>GKE Config Connector<a class="hash-link" href="#gke-config-connector" title="Direct link to heading">#</a></h3><ol start="2"><li><p>Then, it installs GKE Config Connector (via shared/cnrm.sh script)
into <code>system</code> pool.</p><p><a href="https://cloud.google.com/config-connector/docs/overview" target="_blank" rel="noopener noreferrer">Config Connector</a>
is a new GKE cluster add-on that enables declarative
deployment of GCP resources directly from Kubernetes templates.</p><p>This is highly convient, as we can deploy a Pod, an associated minimal privilege Service Account,
and related GCP resources (e.g. CloudSQL instances) within a single template.</p><p>Notice that Config Connector itself needs access to create these GCP resources,
and as such is assigned a highly-privileged Service Account with the
required permissions via a custom IAM role in Terraform. However,
we schedule its pods into <code>system</code> node pool, so it is physically separated
from all &quot;third-party apps&quot; in the cluster.</p><p>If this becomes a big concern, it&#x27;s possible to deploy Config Connector
onto a separate project/cluster altogether,
and then managing &quot;target project&quot; resources from there
(or alternatively, we could use Terraform to deploy these GCP resources,
but that introduces its own complexities).</p><p>However, even the current setup may provide sufficient isolation, and is
still better than the regular &quot;Default Compute Engine Service Account Identity&quot;
typically used for GKE nodes and pods, since
the workloads (apps) are now isolated by multiple layers
(workload identity, containerization, GKE Sandbox where possible,
physical nodes, and Network Policies in the future).</p><p>It&#x27;s also possible to protect GCP resources from deletion when
an associated Config Connector resource is removed. This can be done
via <code>cnrm.cloud.google.com/deletion-policy: abandon</code> annotation for the resource.
We use it for such resources as <code>SQLInstance/Database/User</code>,
<code>ComputeAddress</code>, <code>DNSManagedZone</code>, <code>ComputeDisk</code>, and <code>ComputeResourcePolicy</code>,
as those generally need to &quot;survive&quot; any cluster/app re-deployments.</p><p>Since Config Connector relies on the project-global names of such resources,
they are automatically &quot;acquired&quot; by it on re-deployment. This allows us
to safely delete an entire namespace or even the cluster, and
re-create it later on, so the cluster/namespaces can be treated as &quot;dispensable&quot;
resources that can be completely and easily reproduced via Cloud Build, when needed.</p><p><a href="https://cloud.google.com/config-connector/docs/reference/resources" target="_blank" rel="noopener noreferrer">Here</a>
is a comprehensive list of all possible GCP resources available via Config Connector.</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="global-namespace-in-gke"></a>Global Namespace in GKE<a class="hash-link" href="#global-namespace-in-gke" title="Direct link to heading">#</a></h3><ol start="3"><li><p>Finally, using Config Connector we set up <code>global</code> namespace (see below)
and the following GCP resources in it (shared/global.yaml):</p><ul><li><p>Cloud Armor <a href="https://cloud.google.com/armor/docs/security-policy-concepts" target="_blank" rel="noopener noreferrer">Security Policy</a>,
which firewalls all Ingress endpoints to the Broad CIDRs.</p></li><li><p><a href="https://cloud.google.com/dns/zones" target="_blank" rel="noopener noreferrer">Cloud DNS Managed Zone</a>
for <code>dsp-appsec.broadinstitute.org.</code></p></li><li><p><a href="https://cloud.google.com/compute/docs/disks/scheduled-snapshots" target="_blank" rel="noopener noreferrer">GCE Resource Policy</a>
for disk snapshots (see below).</p></li></ul></li></ol></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/broadinstitute/dsp-appsec-infrastructure-apps/external/docs/docs/SDARQ/How_It_Works/cluster.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/SDARQ/How_It_Works/sdarq-apps"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« App Deployment</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Security_Guidance/Cloud_Security/Overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Overview Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deployment" class="table-of-contents__link">Deployment</a><ul><li><a href="#shared-resources" class="table-of-contents__link">Shared resources</a></li><li><a href="#terraform" class="table-of-contents__link">Terraform</a></li><li><a href="#gke-config-connector" class="table-of-contents__link">GKE Config Connector</a></li><li><a href="#global-namespace-in-gke" class="table-of-contents__link">Global Namespace in GKE</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">SDARQ</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/SDARQ/overview">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/SDARQ/quickstart">Quickstart</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Security Guidance</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/Security_Guidance/overview">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/Security_Guidance/Cloud_Security/overview">Cloud Security</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Contact</h4><ul class="footer__items"><li class="footer__item"><a href="mailto: appsec@broadinstitute.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Broad Institute. Developed by the Application Security Team.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.35195b03.js"></script>
<script src="/assets/js/main.5e765113.js"></script>
</body>
</html>