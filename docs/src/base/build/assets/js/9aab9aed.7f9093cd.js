(self.webpackChunkexternal=self.webpackChunkexternal||[]).push([[921],{2987:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return i},metadata:function(){return p},toc:function(){return l},default:function(){return d}});var n=a(2122),o=a(9756),r=(a(7294),a(3905)),s=["components"],i={id:"sdarq-apps",title:"SDARQ Apps",sidebar_label:"SDARQ Apps"},p={unversionedId:"SDARQ/How_It_Works/sdarq-apps",id:"SDARQ/How_It_Works/sdarq-apps",isDocsHomePage:!1,title:"App Deployment",description:"Next, Cloud Build applies both app-specific and some shared",source:"@site/docs/SDARQ/How_It_Works/apps.md",sourceDirName:"SDARQ/How_It_Works",slug:"/SDARQ/How_It_Works/sdarq-apps",permalink:"/docs/SDARQ/How_It_Works/sdarq-apps",editUrl:"https://github.com/broadinstitute/dsp-appsec-infrastructure-apps/external/docs/docs/SDARQ/How_It_Works/apps.md",version:"current",sidebar_label:"SDARQ Apps",frontMatter:{id:"sdarq-apps",title:"SDARQ Apps",sidebar_label:"SDARQ Apps"},sidebar:"tutorialSidebar",previous:{title:"Quick Start",permalink:"/docs/SDARQ/Quickstart"},next:{title:"Infrastructure",permalink:"/docs/SDARQ/How_It_Works/kubernetes-cluster"}},l=[],c={toc:l};function d(e){var t=e.components,a=(0,o.Z)(e,s);return(0,r.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Next, Cloud Build applies both app-specific and some shared\nKubernetes ",(0,r.kt)("em",{parentName:"p"},"templates")," to deploy each app."),(0,r.kt)("p",null,"Some apps require patches to work properly with Docker/Kubernetes,\nso we build patched images and push them to GCR along the way.\nWe use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/GoogleContainerTools/kaniko"},"Kaniko")," Docker builder\nto speed up the builds through caching."),(0,r.kt)("p",null,"Each Kubernetes deployment is done via an associated ",(0,r.kt)("inlineCode",{parentName:"p"},"deploy.sh")," script\n(e.g. one for CodeDx.\nA quick overview of what that script should do:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/"},"Kubernetes namespace")," for the app.\nNamespaces provide mainly logical/deployment separation,\nbut also some security boundaries for the apps (notably, while\nNetwork Policy is not enabled by default, it can be\n",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/network-policies/"},"configured"),"\nto accept internal cluster traffic only from specific namespaces)."),(0,r.kt)("p",{parentName:"li"},'Namespaces are also very convenient for avoiding "spillover" of\nresources between the apps, as one namespace can be created/destroyed\ncompletely without affecting any others. This is particularly useful\nduring the development of each app.'),(0,r.kt)("p",{parentName:"li"},"We use shared/kube-apply.py script to replace\n",(0,r.kt)("inlineCode",{parentName:"p"},"PROJECT_ID")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"NAMESPACE")," environment variables\nin namespace.yaml template with app-specific values,\nand then apply it. This pattern is used throughout\nother resource deployments later as well.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},'Generate Kubernetes secret(s) used by the app, unless they\'re "external" (e.g. a Slack token).\nThis is done via shared/gen-secret.sh script, which currently uses\n',(0,r.kt)("inlineCode",{parentName:"p"},"/dev/urandom")," to generate a random sequence of alphanumeric characters. However,\nit may be better to use a crypto library in the future instead."),(0,r.kt)("p",{parentName:"li"},"The secrets are generated only once, when they don't exist yet. Otherwise,\nthe script doesn't overwrite them. This provides a simple way to rotate the secrets,\nshould we need that, by just removing them in Kubernetes and re-running the latest\nbuild in Cloud Build."),(0,r.kt)("p",{parentName:"li"},"For the manually created secrets, we'll provide a sample template to deploy them\nfrom your local shell.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set up a Kubernetes volume for the app, if it stores some of its state on disk\n(e.g. DefectDojo and CodeDx)."),(0,r.kt)("p",{parentName:"li"},"This is done via shared/volume.sh script that"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"declares a regional GCE disk (which can be accessed from any of the 2 zones\nin the cluster, while also providing regional replication)"),(0,r.kt)("li",{parentName:"ul"},"sets up daily snapshots of disk content for disaster recovery"),(0,r.kt)("li",{parentName:"ul"},"waits for the disk to be created on GCE"),(0,r.kt)("li",{parentName:"ul"},"sets up Kubernetes\n",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/"},"PersistentVolume and PersistentVolumeClaim"),",\nwhere the latter can be used to associate the volume with a Pod."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If the app needs access to GCP services (e.g. Cloud SQL), apply\nshared/service-account.yaml template to:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"create a Kubernetes Service Account (KSA) for its Pod"),(0,r.kt)("li",{parentName:"ul"},"create a Google Service Account (GSA) that will have access to GCP resources"),(0,r.kt)("li",{parentName:"ul"},"binds these 2 accounts via a Kubernetes annotation and ",(0,r.kt)("inlineCode",{parentName:"li"},"iam.workloadIdentityUser")," role.")),(0,r.kt)("p",{parentName:"li"},"Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"service-account.yaml")," is generic and ",(0,r.kt)("em",{parentName:"p"},"doesn't")," grant access to GCP resources,\nso after applying it, the actual role binding has to be done via an app-specific template\n(but at least, that step is simple).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Apply the app-specific template,\nwhich creates either a Deployment (for stateless apps),\nor a StatefulSet (if the app uses disk)."),(0,r.kt)("p",{parentName:"li"},"We also deploy any app-specific GCP resources (e.g. SQLInstance, SQLUser etc.)\nvia Config Connector resource types, and create a role binding for the service account\n(if any in use), e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"roles/cloudsql.client")," for Cloud SQL."),(0,r.kt)("p",{parentName:"li"},"Finally, it's recommended to set ",(0,r.kt)("inlineCode",{parentName:"p"},"runtimeClassName: gvisor")," for the Pod,\nto enable GKE Sandbox around it. However, some apps (e.g. DefectDojo) may fail\nto work properly with it. In that case, the app can still be deployed without it, but\nwill need an extra configuration snippet for ",(0,r.kt)("inlineCode",{parentName:"p"},"nodeSelector")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"tolerations"),"\n(e.g. see how this is done in defectdojo/deployment.yaml."),(0,r.kt)("p",{parentName:"li"},"For the next steps, this template should also expose\na ",(0,r.kt)("inlineCode",{parentName:"p"},"containerPort")," and a ",(0,r.kt)("inlineCode",{parentName:"p"},"readinessProbe"),", both of which are used\nto reach the app http endpoint from Ingress and to mark it as healthy."),(0,r.kt)("p",{parentName:"li"},"Take a look, for example, at how all of this is done in\ncodedx/deployment.yaml.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Call shared/host.sh script, which:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"declares a global static IP for the service"),(0,r.kt)("li",{parentName:"ul"},"waits for the IP to be created"),(0,r.kt)("li",{parentName:"ul"},"sets up its DNS hostname record in the Managed Zone"),(0,r.kt)("li",{parentName:"ul"},"waits for DNS propagation by repeated host resolution"),(0,r.kt)("li",{parentName:"ul"},"deploys ",(0,r.kt)("a",{parentName:"li",href:"https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs"},"GKE Managed Certificate"),"\nfor the hostname"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Finally, deploy shared/ingress.yaml, which sets up:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/backendconfig"},"Backend Config"),"\nfor Cloud Armor")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/service/"},"Kubernetes Service"),", which:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"exposes internal port(s) to the load balancer"),(0,r.kt)("li",{parentName:"ul"},"applies Backend Config to those"),(0,r.kt)("li",{parentName:"ul"},"sets up container-native load balancing via a\n",(0,r.kt)("a",{parentName:"li",href:"https://cloud.google.com/kubernetes-engine/docs/how-to/standalone-neg"},"Network Endpoint Group")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress"},"GKE Ingress"),",\nwhich ties together all of the above using:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"IP address binding"),(0,r.kt)("li",{parentName:"ul"},"Disallowing raw HTTP (to keep only HTTPS)"),(0,r.kt)("li",{parentName:"ul"},"Managed Certificate binding"),(0,r.kt)("li",{parentName:"ul"},"DNS hostname mapping via Host header of the request"),(0,r.kt)("li",{parentName:"ul"},"URL path mapping for each Service port")))),(0,r.kt)("p",{parentName:"li"},"Please note that ",(0,r.kt)("inlineCode",{parentName:"p"},"ingress.yaml")," may need to be adjusted in an app-specific way\n(e.g. for Sdarq, which exposes multiple internal paths/ports,\nand could use Cloud DNS for Backend Config), in which case\na customized copy of ",(0,r.kt)("inlineCode",{parentName:"p"},"ingress.yaml")," would need to be referenced from ",(0,r.kt)("inlineCode",{parentName:"p"},"deploy.sh"),"."))))}d.isMDXComponent=!0}}]);