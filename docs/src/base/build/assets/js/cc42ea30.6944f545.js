(self.webpackChunkexternal=self.webpackChunkexternal||[]).push([[255],{3277:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},metadata:function(){return l},toc:function(){return p},default:function(){return d}});var o=n(2122),a=n(9756),r=(n(7294),n(3905)),i=["components"],s={id:"kubernetes-cluster",title:"Kubernetes Cluster Architecture",sidebar_label:"AppSec Infrastructure"},l={unversionedId:"SDARQ/How_It_Works/kubernetes-cluster",id:"SDARQ/How_It_Works/kubernetes-cluster",isDocsHomePage:!1,title:"Infrastructure",description:"Deployment",source:"@site/docs/SDARQ/How_It_Works/cluster.md",sourceDirName:"SDARQ/How_It_Works",slug:"/SDARQ/How_It_Works/kubernetes-cluster",permalink:"/docs/SDARQ/How_It_Works/kubernetes-cluster",editUrl:"https://github.com/broadinstitute/dsp-appsec-infrastructure-apps/external/docs/docs/SDARQ/How_It_Works/cluster.md",version:"current",sidebar_label:"AppSec Infrastructure",frontMatter:{id:"kubernetes-cluster",title:"Kubernetes Cluster Architecture",sidebar_label:"AppSec Infrastructure"},sidebar:"tutorialSidebar",previous:{title:"App Deployment",permalink:"/docs/SDARQ/How_It_Works/sdarq-apps"},next:{title:"Overview",permalink:"/docs/Security_Guidance/Cloud_Security/Overview"}},p=[{value:"Deployment",id:"deployment",children:[{value:"Shared resources",id:"shared-resources",children:[]},{value:"Terraform",id:"terraform",children:[]},{value:"GKE Config Connector",id:"gke-config-connector",children:[]},{value:"Global Namespace in GKE",id:"global-namespace-in-gke",children:[]}]}],c={toc:p};function d(e){var t=e.components,n=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"deployment"},"Deployment"),(0,r.kt)("p",null,"All apps are deployed via Cloud Build, as defined in cloudbuild.yaml."),(0,r.kt)("h3",{id:"shared-resources"},"Shared resources"),(0,r.kt)("h3",{id:"terraform"},"Terraform"),(0,r.kt)("p",null,"First, it sets up some common infrastructure:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Using Terraform templates, it deploys a ",(0,r.kt)("em",{parentName:"p"},"regional")," GKE cluster with"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"a dedicated VPC network/subnetwork in ",(0,r.kt)("inlineCode",{parentName:"p"},"us-east1")," region")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"VPC-native networking with\n",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips"},"alias IPs"),",\nto optimize pod communication and provide some security benefits")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"a minimal-privilege GKE node service account\nwith access to Stackdriver logging/monitoring\nand Google Container Registry")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"system")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"sandbox")," node pools,\nspread across 2 availability zones in the region")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/sandbox"},"GKE Sandbox"),"\nenabled for ",(0,r.kt)("inlineCode",{parentName:"p"},"sandbox")," pool,\nwhich will be used for app deployments\n(with additional configuration for the pods, see below).")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/using-containerd"},"Container-Optimized OS with ",(0,r.kt)("inlineCode",{parentName:"a"},"containerd")," runtime"),'\nimage for the nodes (this is required by GKE Sandbox,\nbut we also use it for "system" nodes, to minimize Docker exposure surface)')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/security/shielded-cloud/shielded-vm"},"Shielded VMs"),"\nfor all nodes")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity"},"Workload Identity")," for minimal-privilege app deployments")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/tutorials/network-policy"},"Network Policy")," cluster add-on for future Pod deployments")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler"},"Cluster Autoscaler"),"\nfor ",(0,r.kt)("inlineCode",{parentName:"p"},"sandbox")," pool, to gradually grow the number of nodes as more workloads are deployed to them")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Regular")," ",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels"},"release channel")," for cluster/node upgrades"))))),(0,r.kt)("h3",{id:"gke-config-connector"},"GKE Config Connector"),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Then, it installs GKE Config Connector (via shared/cnrm.sh script)\ninto ",(0,r.kt)("inlineCode",{parentName:"p"},"system")," pool."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/config-connector/docs/overview"},"Config Connector"),"\nis a new GKE cluster add-on that enables declarative\ndeployment of GCP resources directly from Kubernetes templates."),(0,r.kt)("p",{parentName:"li"},"This is highly convient, as we can deploy a Pod, an associated minimal privilege Service Account,\nand related GCP resources (e.g. CloudSQL instances) within a single template."),(0,r.kt)("p",{parentName:"li"},"Notice that Config Connector itself needs access to create these GCP resources,\nand as such is assigned a highly-privileged Service Account with the\nrequired permissions via a custom IAM role in Terraform. However,\nwe schedule its pods into ",(0,r.kt)("inlineCode",{parentName:"p"},"system"),' node pool, so it is physically separated\nfrom all "third-party apps" in the cluster.'),(0,r.kt)("p",{parentName:"li"},'If this becomes a big concern, it\'s possible to deploy Config Connector\nonto a separate project/cluster altogether,\nand then managing "target project" resources from there\n(or alternatively, we could use Terraform to deploy these GCP resources,\nbut that introduces its own complexities).'),(0,r.kt)("p",{parentName:"li"},'However, even the current setup may provide sufficient isolation, and is\nstill better than the regular "Default Compute Engine Service Account Identity"\ntypically used for GKE nodes and pods, since\nthe workloads (apps) are now isolated by multiple layers\n(workload identity, containerization, GKE Sandbox where possible,\nphysical nodes, and Network Policies in the future).'),(0,r.kt)("p",{parentName:"li"},"It's also possible to protect GCP resources from deletion when\nan associated Config Connector resource is removed. This can be done\nvia ",(0,r.kt)("inlineCode",{parentName:"p"},"cnrm.cloud.google.com/deletion-policy: abandon")," annotation for the resource.\nWe use it for such resources as ",(0,r.kt)("inlineCode",{parentName:"p"},"SQLInstance/Database/User"),",\n",(0,r.kt)("inlineCode",{parentName:"p"},"ComputeAddress"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"DNSManagedZone"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ComputeDisk"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"ComputeResourcePolicy"),',\nas those generally need to "survive" any cluster/app re-deployments.'),(0,r.kt)("p",{parentName:"li"},'Since Config Connector relies on the project-global names of such resources,\nthey are automatically "acquired" by it on re-deployment. This allows us\nto safely delete an entire namespace or even the cluster, and\nre-create it later on, so the cluster/namespaces can be treated as "dispensable"\nresources that can be completely and easily reproduced via Cloud Build, when needed.'),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/config-connector/docs/reference/resources"},"Here"),"\nis a comprehensive list of all possible GCP resources available via Config Connector."))),(0,r.kt)("h3",{id:"global-namespace-in-gke"},"Global Namespace in GKE"),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Finally, using Config Connector we set up ",(0,r.kt)("inlineCode",{parentName:"p"},"global")," namespace (see below)\nand the following GCP resources in it (shared/global.yaml):"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Cloud Armor ",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/armor/docs/security-policy-concepts"},"Security Policy"),",\nwhich firewalls all Ingress endpoints to the Broad CIDRs.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/dns/zones"},"Cloud DNS Managed Zone"),"\nfor ",(0,r.kt)("inlineCode",{parentName:"p"},"dsp-appsec.broadinstitute.org."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/compute/docs/disks/scheduled-snapshots"},"GCE Resource Policy"),"\nfor disk snapshots (see below)."))))))}d.isMDXComponent=!0}}]);